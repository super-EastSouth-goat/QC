# 故障排查指南：海康网络相机集成

本文档旨在帮助开发和运维人员排查在集成海康威视（MVS）工业相机时可能遇到的问题。本指南基于 Next.js 前端 + FastAPI 后端架构。

**重要提示**: 如果您遇到了问题，请优先检查本文档列出的常见故障点。

---

## 1. 网络与防火墙配置

**现象**: 前端显示“网络相机连接失败”，浏览器控制台出现 `ERR_CONNECTION_TIMED_OUT` 或 `504 Gateway Timeout`。

- **[ ] 端口开放检查**
  - **边缘机 (后端)**: 确认 **8000** 端口已在 Windows 防火墙中开放入站规则。
  - **云服务器 (前端)**: 确认安全组/防火墙规则允许出站访问边缘机公网 IP (`221.226.60.30`) 的 8000 端口。

- **[ ] 代理超时设置**
  - Next.js API Route (AWS Lambda/Vercel) 通常有执行时长限制（如 10s-60s）。
  - **注意**: 视频流可能会因超时而自动断开。如果出现播放几十秒后卡死，请检查部署平台的超时配置。

- **[ ] 混合内容 (Mixed Content)**
  - 生产环境如果使用 HTTPS，浏览器会阻止直接访问 HTTP 的边缘机接口。
  - **解决方案**: 确保所有请求都经过前端代理 `/api/camera-proxy`，不要在前端代码中直接 `fetch('http://221.226.60.30:8000/...')`。

---

## 2. 硬件与驱动依赖

**现象**: 后端服务运行正常，但无法获取画面；后端日志报错 `Create handle failed` 或 `Open device failed`。

- **[ ] 驱动程序路径**
  - 确认边缘机上 MVS Runtime 已安装。
  - 确认 DLL 路径与代码一致: `C:\Program Files (x86)\Common Files\MVS\Runtime\Win64_x64\MvCameraControl.dll`。

- **[ ] 设备独占检查**
  - **关键**: 工业相机通常不支持多进程同时访问。
  - 请确保边缘机上**没有**打开 MVS 客户端软件或其他占用相机的程序。Python 后端必须独占相机。

- **[ ] 物理连接**
  - 检查网线连接是否牢固。
  - 检查相机供电（PoE 或外接电源）。

---

## 3. 并发与性能

**现象**: 单人访问正常，多人同时访问时画面卡顿、延迟极高或服务崩溃。

- **[ ] 带宽瓶颈**
  - 当前实现采用 MJPEG 直流，每个客户端都会建立独立的视频数据流。
  - **计算**: 1080p MJPEG 流约为 4-8 Mbps。如果有 5 人同时观看，边缘机上行带宽需求约为 20-40 Mbps。请确认边缘机网络带宽是否足够。

- **[ ] 线程阻塞**
  - Python 后端的 `video_feed` 依赖于多线程取流。如果 CPU 负载过高（如同时进行高频 YOLO 推理），可能会导致取流线程饥饿，造成画面丢帧。

---

## 4. 配置与代码细节

**现象**: 请求立即返回 404 或 500 错误。

- **[ ] 环境变量格式**
  - 检查 `.env` 文件中的 `NEXT_PUBLIC_EDGE_API_BASE_URL`。
  - **正确**: `http://221.226.60.30:8000` (末尾**无**斜杠)
  - **错误**: `http://221.226.60.30:8000/` (末尾**有**斜杠，会导致路径拼接错误如 `//api/status`)

- **[ ] 接口响应格式**
  - 如果后端修改了 API 返回结构（如更改了 `suggested_decision` 的值），前端的验证逻辑 `isValidInferenceResponse` 可能会拦截请求。
  - **检查**: 确认前端 `edgeInferenceService.ts` 中的验证逻辑与后端 `main.py` 的返回结构保持一致。

---

## 5. 快速排查步骤

如果遇到问题，请按以下顺序操作：

1. **本地验证 (边缘机)**: 
   在边缘机浏览器访问 `http://localhost:8000/view`。
   - *成功*: 说明相机和后端服务正常，问题在网络或前端。
   - *失败*: 说明问题在相机驱动、硬件连接或后端代码。

2. **接口验证 (边缘机)**:
   查看后端控制台日志。是否有报错信息？

3. **代理验证 (前端)**:
   在浏览器访问 `http://<前端IP>:3110/api/camera-proxy?endpoint=status`。
   - *成功*: 说明前端到后端的网络通路正常。
   - *失败*: 说明存在防火墙拦截或配置错误。
